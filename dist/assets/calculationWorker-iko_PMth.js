(function(){"use strict";const M=self;M.addEventListener("message",n=>{const{type:a,data:t,taskId:s}=n.data;try{let e;switch(a){case"calculateSalary":e=v(t);break;case"calculateSocialInsurance":e=R(t);break;case"calculateIncomeTax":e=E(t);break;case"processAttendanceData":e=O(t);break;default:throw new Error(`未知的任务类型: ${a}`)}M.postMessage({type:"success",taskId:s,result:e})}catch(e){M.postMessage({type:"error",taskId:s,error:e.message})}});function v(n){const{employee:a,month:t,salaryGroup:s,attendanceData:e,positionChanges:o}=n;if(o&&o.length>0)return C(n);const r=parseFloat(a.base_salary)||0,i=S(e,s.rules),c=(n.bonuses||[]).reduce((p,d)=>p+parseFloat(d.amount),0),u={};(s.items||[]).forEach(p=>{p.type==="收入"?u[p.name]=parseFloat(p.amount)||0:p.type==="扣除"&&(u[p.name]=-(parseFloat(p.amount)||0))});const m=r-i+c+Object.values(u).reduce((p,d)=>p+d,0);return{baseSalary:r,attendanceDeductions:i,bonuses:c,salaryItems:u,totalSalary:m,details:{employee:a,month:t,salaryGroup:s}}}function C(n){const{employee:a,month:t,positionChanges:s,attendanceData:e}=n,o=new Date(parseInt(t.split("-")[0]),parseInt(t.split("-")[1]),0).getDate();let r=0,i=0,c=[];const u=[...s].sort((l,y)=>new Date(l.effective_date)-new Date(y.effective_date)),m=new Date(parseInt(t.split("-")[0]),parseInt(t.split("-")[1])-1,1),p=new Date(parseInt(t.split("-")[0]),parseInt(t.split("-")[1]),0);let d=m,b=a.position,I=a.base_salary;for(const l of u){const y=new Date(l.effective_date);if(y<m||y>p)continue;const D=Math.floor((y-d)/(24*60*60*1e3)),F=D/o,f=I*F;r+=f;const h=e.filter(A=>{const _=new Date(A.date);return _>=d&&_<y}),w=S(h,n.salaryGroup.rules);i+=w,c.push({startDate:d,endDate:y,position:b,baseSalary:f,attendanceDeductions:w,days:D,ratio:F}),d=y,b=l.new_position,I=l.new_salary}if(d<p){const l=Math.floor((p-d)/864e5)+1,y=l/o,D=I*y;r+=D;const F=e.filter(h=>{const w=new Date(h.date);return w>=d&&w<=p}),f=S(F,n.salaryGroup.rules);i+=f,c.push({startDate:d,endDate:p,position:b,baseSalary:D,attendanceDeductions:f,days:l,ratio:y})}const k=(n.bonuses||[]).reduce((l,y)=>l+parseFloat(y.amount),0),g={};(n.salaryGroup.items||[]).forEach(l=>{l.type==="收入"?g[l.name]=parseFloat(l.amount)||0:l.type==="扣除"&&(g[l.name]=-(parseFloat(l.amount)||0))});const x=r-i+k+Object.values(g).reduce((l,y)=>l+y,0);return{baseSalary:r,attendanceDeductions:i,bonuses:k,salaryItems:g,totalSalary:x,segments:c,details:{employee:a,month:t,salaryGroup:n.salaryGroup}}}function S(n,a){if(!n||!a)return 0;let t=0,s=0;return n.forEach(e=>{switch(e.status){case"迟到":s++,s>(a.lateFreeCount||0)&&(t+=parseFloat(a.lateDeduction)||0);break;case"严重迟到":t+=parseFloat(a.seriousLateDeduction)||0;break;case"早退":t+=parseFloat(a.earlyLeaveDeduction)||0;break;case"缺卡":t+=parseFloat(a.missedPunchDeduction)||0;break;case"旷工":t+=parseFloat(a.absentDeduction)||0;break}}),t}function R(n){const{employee:a,month:t,socialBase:s,socialRates:e,entryExitRecords:o}=n,r=new Date(parseInt(t.split("-")[0]),parseInt(t.split("-")[1]),0).getDate();let i=r,c=1;if(o&&o.length>0){const D=o.find(f=>{const h=new Date(f.date);return f.type==="entry"&&h.getFullYear()===parseInt(t.split("-")[0])&&h.getMonth()+1===parseInt(t.split("-")[1])}),F=o.find(f=>{const h=new Date(f.date);return f.type==="exit"&&h.getFullYear()===parseInt(t.split("-")[0])&&h.getMonth()+1===parseInt(t.split("-")[1])});if(D){const h=new Date(D.date).getDate();i-=h-1}if(F){const h=new Date(F.date).getDate();i-=r-h}c=i/r}const u=Math.min(Math.max(parseFloat(s.min)||0,parseFloat(a.social_base)||parseFloat(a.base_salary)||0),parseFloat(s.max)||1/0),m=u*parseFloat(e.pension.employee)/100*c,p=u*parseFloat(e.medical.employee)/100*c,d=u*parseFloat(e.unemployment.employee)/100*c,b=u*parseFloat(e.housing.employee)/100*c,I=u*parseFloat(e.pension.company)/100*c,k=u*parseFloat(e.medical.company)/100*c,g=u*parseFloat(e.unemployment.company)/100*c,x=u*parseFloat(e.housing.company)/100*c,l=m+p+d+b,y=I+k+g+x;return{base:u,workDays:i,workRatio:c,employee:{pension:m,medical:p,unemployment:d,housing:b,total:l},company:{pension:I,medical:k,unemployment:g,housing:x,total:y},details:{employee:n.employee,month:t,socialBase:s,socialRates:e}}}function E(n){const{salary:a,socialInsurance:t,taxBase:s,taxRates:e}=n,o=a-t-parseFloat(s.threshold);if(o<=0)return{taxableIncome:0,tax:0,afterTax:a-t,details:n};let r=0,i=0;for(const m of e)if(o>m.min&&(m.max===null||o<=m.max)){r=parseFloat(m.rate)/100,i=parseFloat(m.quickDeduction);break}const c=o*r-i,u=a-t-c;return{taxableIncome:o,tax:c,afterTax:u,details:{...n,appliedRate:r*100,quickDeduction:i}}}function O(n){const{attendanceRecords:a,rules:t}=n,s=a.map(e=>{const o={...e},r=e.check_in?new Date(`2000-01-01 ${e.check_in}`):null,i=e.check_out?new Date(`2000-01-01 ${e.check_out}`):null,c=new Date(`2000-01-01 ${t.standardCheckIn||"09:00:00"}`),u=new Date(`2000-01-01 ${t.standardCheckOut||"18:00:00"}`);return!r&&!i?o.status="旷工":!r||!i?o.status="缺卡":r>c?Math.floor((r-c)/6e4)>(t.seriousLateMinutes||30)?o.status="严重迟到":o.status="迟到":i<u?o.status="早退":o.status="正常",o});return{processedRecords:s,summary:{total:s.length,normal:s.filter(e=>e.status==="正常").length,late:s.filter(e=>e.status==="迟到").length,seriousLate:s.filter(e=>e.status==="严重迟到").length,earlyLeave:s.filter(e=>e.status==="早退").length,missedPunch:s.filter(e=>e.status==="缺卡").length,absent:s.filter(e=>e.status==="旷工").length}}}})();
